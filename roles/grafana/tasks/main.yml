---
- name: "Include grafana installation tasks"
  ansible.builtin.include_tasks: install.yml

- name: "Wait for the Grafana server to become available"
  ansible.builtin.wait_for:
    host: "127.0.0.1"
    port: "{{ grafana_port }}"
    state: started
    delay: 10

- name: "Reset default admin password"
  no_log: "{{ grafana_no_log_secrets }}"
  changed_when: false
  ansible.builtin.command: >
    grafana-cli admin reset-admin-password "{{ admin_api_password }}"

- name: "Include user creation tasks"
  when: grafana_users is defined
  loop: "{{ grafana_users }}"
  loop_control:
    loop_var: user
  ansible.builtin.include_tasks: users.yml

- name: "Configure custom dashboards"
  when: grafana_dashboard_source_path is defined
  ansible.builtin.include_tasks: dashboards.yml

- name: "Configure public dashboards"
  when: grafana_public_dashboards is defined
  loop: "{{ grafana_public_dashboards }}"
  loop_control:
    loop_var: public_dashboard
  ansible.builtin.include_tasks: import_pub_dashboard.yml

- name: "Create a plugin directory"
  ansible.builtin.file:
    path: "{{ grafana_plugins_dir }}"
    state: directory
    owner: "{{ grafana_user }}"
    group: "{{ grafana_group }}"
    mode: "0755"

- name: "Configure plugins"
  when: grafana_plugins is defined
  loop: "{{ grafana_plugins }}"
  loop_control:
    loop_var: plugin
  ansible.builtin.include_tasks: plugins.yml

- name: "Create a datasources directory"
  ansible.builtin.file:
    path: "{{ grafana_datasource_dir }}"
    state: directory
    owner: "{{ grafana_user }}"
    group: "{{ grafana_group }}"
    mode: "0755"

- name: "Configure datasources"
  when: grafana_datasource_source_path is defined
  ansible.builtin.include_tasks: datasources.yml
